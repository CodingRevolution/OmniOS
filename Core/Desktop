--[[
	Desktop in ComputerCraft
	by Creator
	for TheOS
]]--
--Variables--
local textutilsserialize = textutils.serialize
local textutilsunserialize = textutils.unserialize
local w,h = term.getSize()
local Settings = {}
local result = {}
local Main = {}
local QuickSettings = {}

--Functions--
local function readFile(_path)
	local file = fs.open(_path,"r")
	local data = file.readAll()
	file.close()
	return data
end

local function split(str,sep)
	local buffer = {}
	for token in str:gmatch(sep) do
		buffer[#buffer+1] = token
	end
	return buffer
end
--Object table--
Main.ButtonTable = {
	quickSettings = {
		name = "quickSettings",
		label = ">",
		xPos = 1,
		yPos = h,
		xLength = 1,
		yLength = h,
		xTextPos = 1,
		yTextPos = 1,
		fgColor = colors.white,
		bgColor = Settings.bgColor,
		returnValue = "quickSettings",
	},
	windowPlus = {
		name = "windowPlus",
		label = "+",
		xPos = w,
		yPos = 1,
		xLength = 1,
		yLength = 1,
		xTextPos = 1,
		yTextPos = 1,
		fgColor = colors.white,
		bgColor = Settings.bgColor,
		returnValue = "windowPlus",
	},
	windowMinus = {
		name = "windowMinus",
		label = "-",
		xPos = 1,
		yPos = 1,
		xLength = 1,
		yLength = 1,
		xTextPos = 1,
		yTextPos = 1,
		fgColor = colors.white,
		bgColor = Settings.bgColor,
		returnValue = "windowMinus",
	},
}

QuickSettings.ButtonTable = {
	X = {
		name = "X",
		label = "X",
		xPos = w,
		yPos = h-7,
		xLength = 1,
		yLength = 1,
		xTextPos = 1,
		yTextPos = 1,
		fgColor = colors.white,
		bgColor = Settings.bgColor,
		returnValue = "X",
	},
}

--Loading settings--

local buffer = readFile("TheOS/Desktop/Settings")
Settings = textutils.unserialize( buffer )

--Initializing GUI components
local gui = Interact.Initialize()
local mainLayout = gui.Layout.new()
local quickSettingsLayout = gui.Layout.new()

--Initializing Buttons--
--Main--
local quickSettings = gui.Button.new(Main.ButtonTable.quickSettings)
local windowPlus = gui.Button.new(Main.ButtonTable.windowPlus)
local windowMinus = gui.Button.new(Main.ButtonTable.windowMinus)
local mainBgColor = gui.BackgroundColor.new({color = Settings.bgColor})

--QuickSettings--
local X = gui.Button.new(QuickSettings.ButtonTable.X)
local quickSettingsBgColor = gui.BackgroundColor.new({color = colors.grey})

--Initializing structures--
--Main--
mainLayout:addButton(quickSettings:returnData())
mainLayout:addButton(windowPlus:returnData())
mainLayout:addButton(windowMinus:returnData())
mainLayout:addBackgroundColor(mainBgColor:returnData())

--QuickSettings--
quickSettingsLayout:addButton(X:returnData())
quickSettingsLayout:addBackgroundColor(quickSettingsBgColor:returnData())


function writeTable()
	file = fs.open("TheOS/Desktop/Settings","w")
	file.write(textutilsserialize({
		bgColor = colors.blue,
	}))
	file.close()
end
--writeTable()

--Code--
while true do
	mainLayout:draw()
	local resultRaw = gui.eventHandler(mainLayout)
	result = split(resultRaw,"[^:]+")
	if result[1] == "Button" then
		quickSettingsLayout:draw()
		gui.eventHandler(quickSettingsLayout)
	end
	os.pullEvent()
end