--Variables--
args = {...}
local currWindow = 1
local Settings = {}
local Shortcuts = {}
local textutilsserialize = textutils.serialize
local textutilsunserialize = textutils.unserialize
term.redirect(term.native())
print(textutilsserialize(args))
--Functions--
local function loadShortcut(x)
	local m = fs.open("TheOS/Desktop/"..tostring(x)..".shortcuts","r")
	Shortcuts = textutilsunserialize(m.readAll())
	m.close()
end

local function loadSettings()
	local n = fs.open("TheOS/Desktop/Settings","r")
	Settings = textutilsunserialize(n.readAll())
	n.close()
end


local function drawShortcuts(t)
	local a = 0
	for i,v in pairs(t) do
		a = a + 1
		local line = 0
		local xPos = (v[1]-1)*9+2 
		local yPos = (v[2]-1)*7+2
		term.setCursorPos(xPos,yPos)
		local image = {}
		local f = fs.open(v[3]..".ico","r")
		image = textutilsunserialize(f.readAll())
		f.close()
		term.setBackgroundColor(colors.black)
		paintutils.drawImage(image[1],xPos,yPos)
		
		term.setBackgroundColor(colors.cyan)
		term.setTextColor(colors.black)
		term.setCursorPos(xPos,yPos)
		local buffer = {}
		for token in string.gmatch(image[2],"[^%s]+") do
			buffer[#buffer+1] = token
		end
		for i,v in pairs(buffer) do
			if string.sub(v,1,1) == "<" and string.sub(v,-1,-1) == ">"then
				local toAnalize = string.sub(v,2,-2)
				if toAnalize == "newLine" then
					line = line + 1
					term.setCursorPos(xPos,yPos+line)
				else
					local internalBuffer = {}
					for token in string.gmatch(toAnalize,"[^:]+") do
						internalBuffer[#internalBuffer+1] = token
					end
					if internalBuffer[1] == "fgColor" then
						term.setTextColor(colors[internalBuffer[2]])
					end
				end
			else
				term.write(v)
			end
		end
	end
	--term.setTextColor(colors.black)
	--print(a)
end

--Code--
--Load Settings
loadSettings()

--Load Shortcuts--
loadShortcut(currWindow)

--Code--
term.setBackgroundColor(colors.cyan)
term.setTextColor(colors.black)
term.clear()
term.setCursorPos(1,1)
print(fs.exists("TheOS/Desktop/Settings"))
print(textutilsserialize(Settings))
print("meh")
print(args[1])
os.pullEvent()
term.clear()
drawShortcuts(Shortcuts)
os.pullEvent()